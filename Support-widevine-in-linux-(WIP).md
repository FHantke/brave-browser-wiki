### This document describes about how widevine is enabled in brave linux (In-progress) ###

* Related gn args
  * gn args in `third_party/widevine/cdm/widevine.gni`
    * enable_widevine - currently enabled for windows and macos by args.gn (see lib/config.js)
    * library_widevine_cdm_available - enabled by default on all platforms (window/mac/linux)
    * enable_library_widevine_cdm = enable_widevine && enable_library_cdms && library_widevine_cdm_available
      - only linux is false because enable_widevine is false in linux
    * enable_widevine_cdm_component = enable_library_widevine_cdm && (is_win || is_mac)
    * bundle_widevine_cdm = enable_library_widevine_cdm && is_chrome_branded
      - only chrome uses
      - brave uses widevine as a component
    * enable_widevine_cdm_host_verification = enable_library_widevine_cdm && enable_cdm_host_verification
      - only chrome uses

  * gn args in src/media/media_options.gni
    * enable_library_cdms = (is_linux && !is_chromecast) || is_mac || is_win
      - Enables the use of library CDMs that implements the interface defined at `media/cdm/api/content_decryption_module.h`
    * enable_cdm_host_verification = enable_library_cdms && (is_mac || is_win) && is_chrome_branded
      - only chrome uses

* Build flags - `third_party/widevine/cdm/buildflags.h`
  * "ENABLE_WIDEVINE=$enable_widevine"
  * "BUNDLE_WIDEVINE_CDM=$bundle_widevine_cdm"
  * "ENABLE_WIDEVINE_CDM_COMPONENT=$enable_widevine_cdm_component"
  * In brave, BUNDLE_WIDEVINE_CDM is disabled

* Preference - `kWidevineOptedIn`
  * true when user enable & installs widevine module explicitly from content settings dialog
  * default is false
  * If this is false, `RegisterWidevineCdmComponent()` doesn't install/update.<br>
    Because of this, calling `RegisterWidevineCdmComponent()` at startup doesn't install widevine cdm library.
  * `RegisterWidevineCdmComponent()`
    * widevine_cdm_component_installer.cc in chromium_src/chrome/browser/component_updater
    * At startup, RegisterWidevineCdmComponent() is called by RegisterComponentsForUpdate() in chrome_browser_main.cc

* Content settings related model
  * BraveWidevineBlockedImageModel
    - In linux, BraveGenerateContentSettingImageModels doesn't include this model.
    - Surrounded by ENABLE_WIDEVINE_CDM_COMPONENT
  * BraveWidevineContentSettingPluginBubbleModel

* Test pages that needs widevine cdm
  * https://bitmovin.com/demos/drm
  * https://shaka-player-demo.appspot.com/demo/#asset=https://storage.googleapis.com/shaka-demo-assets/angel-one/dash.mpd;lang=en-US;build=uncompiled

* Docs about EME(Encrypted Media Extensions) and CDM Interface
  * https://developers.google.com/web/fundamentals/media/eme
  * enable widevine on chromium-based browser (outdated)
    - https://news.softpedia.com/news/you-can-now-use-netflix-on-vivaldi-and-other-chromium-based-web-browsers-506365.shtml
    - https://gist.github.com/ruario/3c873d43eb20553d5014bd4d29fe37f1
  * Library CDM Interface
    - https://cs.chromium.org/chromium/src/media/cdm/api/README.md

* Enable widevine support in brave linux
  * Component or Bundle?
    - Chrome bundles widevine in linux
    - Brave will use component
  * Starts with enabling gn args
    - Set true to enable_widevine in args.gn
    - enable_widevine_cdm_component = enable_library_widevine_cdm && (is_win || is_mac || is_desktop_linux)

* How registration/install works?
  * It starts with RegisterAndInstallWidevine() in widevine_cdm_component_installer.cc (chromium_src)
    ```void RegisterAndInstallWidevine() {
        // This code is similar to RegisterWidevineCdmComponent_ChromiumImpl
        // but that ignores the callback, and we handle it so we can force
        // an on demand update.
        auto installer = base::MakeRefCounted<component_updater::ComponentInstaller>(
            std::make_unique<WidevineCdmComponentInstallerPolicy>());
        installer->Register(g_browser_process->component_updater(),
            base::Bind(&OnWidevineRegistered));
      }```
  * component id is generated by Policy::GetHash() => component extension id
  * ComponentInstaller::Register() 
    * ComponentInstaller::StartRegistration()
    * ComponentInstaller::FinishRegistration()
    * ComponentInstaller::Install()
      * ComponentInstaller::ComponentReady()
        * WidevineCdmComponentInstallerPolicy::ComponentReady() 
          * WidevineCdmComponentInstallerPolicy::UpdateCdmPath()
            * PostTask -> RegisterWidevineCdmWithChrome()
              * CdmRegistry::GetInstance()->RegisterCdm(content::CdmInfo())

* How to check update from `brave://components`
  * ComponentsDOMHandler::HandleCheckUpdate()
    * ComponentsUI::OnDemandUpdate(component_id)
      * CrxUpdateService::OnDemandUpdate()

* How browser/renderer knows whether widevine is supported or not?
  * In browser side
    * KeySystemSupportImpl::IsKeySystemSupported()
      * KeySystemSupportImpl::GetCdmInfoForKeySystem() checks all registered cdms by using
        * CdmRegistry::GetInstance()->GetAllRegisteredCdms())

  * In renderer side
    * NavigatorRequestMediaKeySystemAccess::requestMediaKeySystemAccess()
      * MediaKeysController::EncryptedMediaClient()
        * RenderFrameImpl::EncryptedMediaClient()
          * MediaFactory::EncryptedMediaClient()
            * WebEncryptedMediaClientImpl::WebEncryptedMediaClientImpl() - KeySystemsImpl()::GetInstance() 호출
              * KeySystemsImpl::UpdateSupportedKeySystems() - Called when KeySystemsImpl is initialized
                * supported key systems is gettered vi `MediaClient()`, then they are cached by KeySystemsImpl::AddSupportedKeySystems()
                * KeySystemsImpl::key_system_properties_map_
                * RenderMediaClient::AddSupportedKeySystems()
                  * ChromeContentRendererClient::AddSupportedKeySystems()
                    * ChromeKeySystemsProvider::AddSupportedKeySystems()
                      * AddChromeKeySystems() in chrome/renderer/media/chrome_key_systems.cc
                        * AddWidevine()
                          * checks content::IsKeySystemSupported(kWidevineKeySystem, &capability)
                            * ```bool IsKeySystemSupported(
                                  const std::string& key_system,
                                  media::mojom::KeySystemCapabilityPtr* key_system_capability) {
                                DVLOG(3) << __func__ << " key_system: " << key_system;

                                bool is_supported = false;
                                media::mojom::KeySystemSupportPtr key_system_support;
                                content::RenderThread::Get()->GetConnector()->BindInterface(
                                    mojom::kBrowserServiceName, mojo::MakeRequest(&key_system_support));

                                key_system_support->IsKeySystemSupported(key_system, &is_supported,
                                                                        key_system_capability);
                                return is_supported;
                              }
                              ```

* CdmService
  * It is utility process that services cdm to renderer via browser
  * CdmService loads cdm library into its process

To support widevine in linux, custom installer/updater should registers it to `CdmRegistry`.